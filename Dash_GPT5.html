<!doctype html>
<html lang="pt-br">
<head>
<meta charset="utf-8"/>
<title>Dashboard Grazziotin ‚Äî MVP</title>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<script defer src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<style>
  :root{
    --bg:#0f1115; --panel:#151922; --ink:#e8eaee; --muted:#9aa3b2; --line:#1f2430;
    --gap:20px; --radius:14px;
    --shadow: 0 10px 30px rgba(0,0,0,.35), 0 2px 8px rgba(0,0,0,.25);
    --card-shadow: 0 12px 24px rgba(0,0,0,.35);
    --bar:#cbd5e1; --bar2:#94a3b8;
  }
  *{box-sizing:border-box}
  body{
    margin:0;color:var(--ink);
    background:
      radial-gradient(1200px 1200px at 20% -10%, #1a2030 0%, transparent 60%),
      radial-gradient(1000px 1000px at 120% 0%, #121829 0%, transparent 60%),
      var(--bg);
    font:15px/1.5 system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Arial,sans-serif;
  }
  .wrap{max-width:1240px;margin:0 auto;padding:28px}
  header{display:flex;align-items:center;justify-content:space-between;margin-bottom:8px}
  .brand{display:flex;align-items:center;gap:10px}
  .dot{width:10px;height:10px;border-radius:50%;background:linear-gradient(180deg,#cbd5e1,#94a3b8);box-shadow:0 2px 6px rgba(0,0,0,.3)}
  h1{font-size:18px;margin:0}
  .muted{color:var(--muted)}
  .surface{background:linear-gradient(180deg,rgba(255,255,255,.02),rgba(255,255,255,0));border:1px solid var(--line);border-radius:var(--radius);box-shadow:var(--shadow)}
  .actions{display:flex;align-items:center;gap:10px}
  .link-btn{border:1px solid var(--line);background:#0f141e;color:var(--ink);border-radius:10px;padding:8px 12px;cursor:pointer}

  /* filtros */
  .filters{display:grid;grid-template-columns:1fr;gap:14px;margin:16px 0 12px}
  @media (min-width:980px){ .filters{grid-template-columns:1fr 1fr 1fr} }
  .field{display:flex;flex-direction:column;gap:6px}
  .label{font-size:.9rem;color:var(--muted)}
  .select{appearance:none;background:#0f141e;border:1px solid var(--line);color:var(--ink);border-radius:10px;padding:10px 12px;min-height:40px}
  .period-row{display:flex;gap:8px;align-items:center}
  .icon-btn{border:1px solid var(--line);background:#0f141e;color:var(--ink);border-radius:10px;padding:10px 12px;cursor:pointer}

  /* calend√°rio overlay (range) */
  .cal-overlay{position:fixed;inset:0;background:rgba(0,0,0,.4);display:none;align-items:center;justify-content:center;z-index:50}
  .cal{background:#0f141e;border:1px solid var(--line);border-radius:12px;box-shadow:var(--shadow);padding:12px;width:320px;color:var(--ink)}
  .cal header{display:flex;align-items:center;justify-content:space-between;margin-bottom:6px}
  .cal header button{border:1px solid var(--line);background:#0f141e;color:var(--ink);border-radius:8px;padding:6px 8px;cursor:pointer}
  .cal .month{font-weight:600}
  .cal .grid{display:grid;grid-template-columns:repeat(7,1fr);gap:4px;margin-top:6px}
  .cal .dow{font-size:.8rem;color:var(--muted);text-align:center}
  .cal .day{height:34px;display:flex;align-items:center;justify-content:center;border-radius:8px;cursor:pointer;border:1px solid transparent}
  .cal .day:hover{background:#151b28}
  .cal .day.disabled{opacity:.35;pointer-events:none}
  .cal .day.sel{background:#1f2937;border-color:#334155}
  .cal .day.range{background:#1b2433}
  .cal footer{display:flex;gap:8px;justify-content:flex-end;margin-top:10px}
  .cal footer button{border:1px solid var(--line);background:#131a26;color:var(--ink);border-radius:10px;padding:8px 12px;cursor:pointer}

  /* cards */
  .cards{display:grid;gap:14px;margin:14px 0 20px}
  @media (min-width:980px){ .cards{grid-template-columns:1fr 1fr} }
  .cards-row2{display:grid;gap:14px;margin:0 0 20px}
  @media (min-width:980px){ .cards-row2{grid-template-columns:repeat(3,1fr)} }
  .card{padding:16px 16px 14px;box-shadow:var(--card-shadow)}
  .big-metric{display:flex;justify-content:space-between;align-items:baseline;gap:12px}
  .big-left{font:700 30px/1.2 system-ui}
  .big-right{font:600 22px/1.2 system-ui;color:#c7cfdb}
  .metric{display:flex;flex-direction:column;gap:4px}
  .metric .value{font:600 20px/1.2 system-ui}

  /* grid de gr√°ficos */
  .grid{display:grid;gap:var(--gap);grid-template-columns:1fr}
  @media (min-width:980px){ .grid{grid-template-columns:1fr 1fr} }
  .panel{padding:16px;display:flex;flex-direction:column;gap:10px}
  .panel h3{margin:0 0 4px 0;font-size:16px;font-weight:600}
  .chart-box{position:relative;width:100%;height:360px;border-radius:12px;overflow:hidden}
  .chart-box.tall{height:auto}
  canvas.chart{position:absolute;inset:0;width:100%!important;height:100%!important;display:block}

  footer{margin:24px 0 8px;color:var(--muted);text-align:center}
</style>
</head>
<body>
<div class="wrap">
  <header>
    <div class="brand"><div class="dot"></div><h1>Dashboard Grazziotin ‚Äî <span class="muted">MVP Kommo</span></h1></div>
    <div class="actions">
      <button id="btn-refresh" class="link-btn" title="For√ßar atualiza√ß√£o agora">Atualizar agora</button>
      <div class="muted">M√°x. 90 dias</div>
    </div>
  </header>

  <!-- FILTROS -->
  <section class="filters">
    <div class="field">
      <div class="label">Per√≠odo</div>
      <div class="period-row">
        <select id="f-periodo" class="select" title="Per√≠odo">
          <option value="hoje">Hoje</option>
          <option value="ontem">Ontem</option>
          <option value="ultima-semana" selected>√öltima semana</option>
          <option value="ultimo-mes">√öltimo m√™s</option>
          <option value="max">M√°ximo</option>
          <option value="custom">Personalizado</option>
        </select>
        <button id="btn-cal" class="icon-btn" title="Escolher intervalo">üìÖ</button>
      </div>
    </div>

    <div class="field">
      <div class="label">Usu√°rio</div>
      <select id="f-usuario" class="select">
        <option value="">Todos</option>
      </select>
    </div>

    <div class="field">
      <div class="label">Funil</div>
      <select id="f-funil" class="select">
        <option value="">Todos</option>
      </select>
    </div>
  </section>

  <!-- Calend√°rio overlay -->
  <div id="cal-overlay" class="cal-overlay" role="dialog" aria-modal="true">
    <div class="cal">
      <header>
        <button id="cal-prev" aria-label="M√™s anterior">‚óÄ</button>
        <div class="month" id="cal-month">M√™s</div>
        <button id="cal-next" aria-label="Pr√≥ximo m√™s">‚ñ∂</button>
      </header>
      <div class="grid" id="cal-grid">
        <div class="dow">S</div><div class="dow">T</div><div class="dow">Q</div><div class="dow">Q</div><div class="dow">S</div><div class="dow">S</div><div class="dow">D</div>
      </div>
      <footer>
        <button id="cal-cancel">Cancelar</button>
        <button id="cal-ok">OK</button>
      </footer>
    </div>
  </div>

  <!-- CARDS -->
  <section class="cards">
    <div class="surface card">
      <div class="big-metric">
        <div>
          <div class="label">Leads ganhos</div>
          <div class="big-left" id="ganhos-qtd">‚Äî</div>
        </div>
        <div class="big-right" id="ganhos-valor">‚Äî</div>
      </div>
    </div>
    <div class="surface card">
      <div class="big-metric">
        <div>
          <div class="label">Leads perdidos</div>
          <div class="big-left" id="perdas-qtd">‚Äî</div>
        </div>
        <div class="big-right" id="perdas-valor">‚Äî</div>
      </div>
    </div>
  </section>

  <section class="cards-row2">
    <div class="surface card metric">
      <div class="label">Todos os Leads</div>
      <div class="value" id="card-total">‚Äî</div>
    </div>
    <div class="surface card metric">
      <div class="label">Ticket m√©dio</div>
      <div class="value" id="card-ticket">‚Äî</div>
    </div>
    <div class="surface card metric">
      <div class="label">Ciclo de venda (dias)</div>
      <div class="value" id="card-ciclo">‚Äî</div>
    </div>
  </section>

  <!-- GR√ÅFICOS -->
  <section class="grid">
    <div class="surface panel">
      <h3>Dados de Prospec√ß√£o Ativa</h3>
      <div id="box-prosp" class="chart-box tall"><canvas id="chart-prospeccao" class="chart"></canvas></div>
    </div>

    <div class="surface panel">
      <h3>Vendas por canal de entrada</h3>
      <div class="chart-box"><canvas id="chart-canais" class="chart"></canvas></div>
    </div>

    <div class="surface panel">
      <h3>Chamadas realizadas</h3>
      <div class="chart-box"><canvas id="chart-chamadas" class="chart"></canvas></div>
    </div>

    <div class="surface panel">
      <h3>Vendas por usu√°rio</h3>
      <div class="chart-box"><canvas id="chart-usuarios" class="chart"></canvas></div>
    </div>
  </section>

  <footer>Grazziotin Consultoria Comercial ‚Ä¢ design minimalista & luxuoso</footer>
</div>

<script>
/* =======================
   CONFIGURE AQUI
   ======================= */
const GAS_ENDPOINT_URL = "https://script.google.com/macros/s/AKfycbwIJaikbGhLnyQQD61hi5wQ-mJ86r3coq4djRD644P8lfJfS1DpxnDQpEofbQIBi71_/exec";

/* =======================
   HELPERS
   ======================= */
async function fetchJSON(url){
  const r = await fetch(url,{cache:"no-store"});
  const t = await r.text();
  if(!r.ok) throw new Error("HTTP "+r.status+" ‚Äî "+t.slice(0,120));
  let j; try{ j = JSON.parse(t); }catch(e){ throw new Error("Resposta n√£o √© JSON."); }
  return j;
}
const toBRL = n => (Number(n)||0).toLocaleString("pt-BR",{style:"currency",currency:"BRL"});
const norm  = v => String(v ?? "").toLowerCase().trim();
const tagsToArray = csv => (csv||"").split(",").map(s=>s.trim()).filter(Boolean);
const ddmm = d => String(d.getDate()).padStart(2,"0") + "/" + String(d.getMonth()+1).padStart(2,"0");
function qs(name){ const m = new URLSearchParams(location.search).get(name); return m; }

/* =======================
   CARGA (sempre 90 dias)
   ======================= */
async function fetchAllFromServer(){
  const [leadsResp, callsResp, usersResp, pipesResp] = await Promise.all([
    fetchJSON(`${GAS_ENDPOINT_URL}?periodo=90`),
    fetchJSON(`${GAS_ENDPOINT_URL}?list=calls`),
    fetchJSON(`${GAS_ENDPOINT_URL}?list=users`),
    fetchJSON(`${GAS_ENDPOINT_URL}?list=pipelines`)
  ]);
  return {
    leads: (leadsResp.dados||[]).map(r => ({
      id:r[0], created_at:r[1], vendedor:r[2]||"‚Äî",
      valor:Number(r[3])||0, etapa:r[4]||"", tags:r[5]||"",
      source:String(r[6]??""), pipeline:String(r[7]??""), canal:String(r[8]??""),
      closed_at:r[9]||""
    })),
    calls: (callsResp.dados||[]).map(r => ({
      note_id:r[0], created_at:r[1], created_by:r[2], type:r[3],
      duration:Number(r[4]||0), phone:r[5]||"", link:r[6]||"", lead_id:r[7]||""
    })),
    users: (usersResp.dados||[]).map(r => r[1]).filter(Boolean),
    pipelines: Array.from(new Set((pipesResp.dados||[]).map(r => r[1]).filter(Boolean)))
  };
}

/* =======================
   CACHE DI√ÅRIO (04:30)
   ======================= */
const CACHE_KEY = "grazziotin_cache_v1";
function getCache(){ try{ return JSON.parse(localStorage.getItem(CACHE_KEY)||""); }catch(e){ return null; } }
function setCache(obj){ localStorage.setItem(CACHE_KEY, JSON.stringify(obj)); }
function todayGate0430(){
  const now = new Date();
  return new Date(now.getFullYear(), now.getMonth(), now.getDate(), 4, 30, 0, 0); // 04:30 local
}
function shouldFetchNow(force=false){
  if (force) return true;
  const cache = getCache();
  const now = new Date();
  const gate = todayGate0430();
  // se ainda n√£o passou das 04:30, nunca atualiza
  if (now < gate) return false;
  // se n√£o tem cache, busca
  if (!cache || !cache.ts) return true;
  const ts = new Date(cache.ts);
  // se o cache √© antes do gate de HOJE, busca
  return ts < gate;
}

/* =======================
   ESTADO GLOBAL
   ======================= */
let ALL = { leads:[], calls:[], users:[], pipelines:[] };
let ALL_CHANNELS = []; // canais (para exibir zerados)

/* =======================
   FILTROS / PER√çODO
   ======================= */
const fPeriodo = document.getElementById("f-periodo");
const fUsuario = document.getElementById("f-usuario");
const fFunil   = document.getElementById("f-funil");
const btnCal   = document.getElementById("btn-cal");
const btnRefresh = document.getElementById("btn-refresh");

const PERIOD_LABELS = {
  "hoje":"Hoje", "ontem":"Ontem", "ultima-semana":"√öltima semana",
  "ultimo-mes":"√öltimo m√™s", "max":"M√°ximo", "custom":"Personalizado"
};

let customRange = null; // {start, end}

function computeMaxRange(){
  const dates = [];
  ALL.leads.forEach(l => { if (l.created_at) dates.push(new Date(l.created_at).getTime()); if (l.closed_at) dates.push(new Date(l.closed_at).getTime()); });
  ALL.calls.forEach(c => { if (c.created_at) dates.push(new Date(c.created_at).getTime()); });
  if (!dates.length){
    const today = new Date(); today.setHours(0,0,0,0);
    return { start: today, end: new Date(today.getTime()+86399999) };
  }
  const minT = Math.min(...dates), maxT = Math.max(...dates);
  const start = new Date(minT); start.setHours(0,0,0,0);
  const end = new Date(maxT);  end.setHours(23,59,59,999);
  return { start, end };
}

function getRange(choice){
  if (choice === "custom" && customRange) return customRange;
  if (choice === "max") return computeMaxRange();

  const today = new Date(); today.setHours(0,0,0,0);
  if (choice === "hoje")  return {start: today, end: new Date(today.getTime()+86399999)};
  if (choice === "ontem"){ const d=new Date(today); d.setDate(d.getDate()-1); return {start:d, end:new Date(d.getTime()+86399999)}; }
  if (choice === "ultima-semana"){
    // √∫ltima semana COMPLETA (seg‚Üídom) anterior √† atual
    const now = new Date();
    const day = (now.getDay()+6)%7; // 0=seg
    const lastMon = new Date(now); lastMon.setDate(now.getDate()-day-7); lastMon.setHours(0,0,0,0);
    const lastSun = new Date(lastMon); lastSun.setDate(lastMon.getDate()+6); lastSun.setHours(23,59,59,999);
    return {start:lastMon, end:lastSun};
  }
  if (choice === "ultimo-mes"){
    const now = new Date();
    const firstThis = new Date(now.getFullYear(), now.getMonth(), 1);
    const lastMonthEnd = new Date(firstThis-1);
    const firstLast = new Date(lastMonthEnd.getFullYear(), lastMonthEnd.getMonth(), 1);
    firstLast.setHours(0,0,0,0); lastMonthEnd.setHours(23,59,59,999);
    return {start:firstLast, end:lastMonthEnd};
  }
  // fallback: rolling 7
  const s = new Date(); s.setDate(s.getDate()-6); s.setHours(0,0,0,0);
  const e = new Date(); e.setHours(23,59,59,999);
  return {start:s, end:e};
}

function setPeriodSummaryLabel(choice, range){
  const startTxt = ddmm(range.start), endTxt = ddmm(range.end);
  const opts = Array.from(fPeriodo.options);
  opts.forEach(opt => {
    const base = PERIOD_LABELS[opt.value] || opt.textContent;
    if (opt.value === choice){
      opt.textContent = `${base} ‚Äî ${startTxt} a ${endTxt}`;
    } else {
      opt.textContent = base;
    }
  });
}

/* =======================
   CALEND√ÅRIO (RANGE)
   ======================= */
let calState = { visible:false, cursor:new Date(), start:null, end:null };
const calOverlay = document.getElementById("cal-overlay");
const calMonthEl = document.getElementById("cal-month");
const calGrid = document.getElementById("cal-grid");
const btnPrev = document.getElementById("cal-prev");
const btnNext = document.getElementById("cal-next");
const btnOk   = document.getElementById("cal-ok");
const btnCancel = document.getElementById("cal-cancel");

btnCal.addEventListener("click", ()=> openCalendar(customRange));
btnPrev.addEventListener("click", ()=>{ calState.cursor.setMonth(calState.cursor.getMonth()-1); renderCalendar(); });
btnNext.addEventListener("click", ()=>{ calState.cursor.setMonth(calState.cursor.getMonth()+1); renderCalendar(); });
btnCancel.addEventListener("click", closeCalendar);
btnOk.addEventListener("click", ()=>{
  if (!calState.start || !calState.end) return;
  calState.start.setHours(0,0,0,0);
  calState.end.setHours(23,59,59,999);
  customRange = { start: new Date(calState.start), end: new Date(calState.end) };
  fPeriodo.value = "custom";
  closeCalendar();
  applyAll();
});

function openCalendar(initialRange){
  calState.visible = true;
  calOverlay.style.display = "flex";
  calState.cursor = (initialRange?.start) ? new Date(initialRange.start) : new Date();
  calState.cursor.setDate(1);
  calState.start = initialRange?.start ? new Date(initialRange.start) : null;
  calState.end   = initialRange?.end   ? new Date(initialRange.end)   : null;
  renderCalendar();
}
function closeCalendar(){ calState.visible=false; calOverlay.style.display="none"; }

function renderCalendar(){
  const y = calState.cursor.getFullYear();
  const m = calState.cursor.getMonth();
  calMonthEl.textContent = calState.cursor.toLocaleDateString("pt-BR",{month:"long", year:"numeric"});
  // remove dias (mant√©m DOW)
  [...calGrid.querySelectorAll(".day")].forEach(n=>n.remove());

  const firstDay = new Date(y, m, 1);
  const lastDay  = new Date(y, m+1, 0);
  const startIdx = firstDay.getDay(); // 0 dom..6 s√°b

  for (let i=0; i<startIdx; i++){
    const dummy = document.createElement("div");
    dummy.className = "day disabled";
    calGrid.appendChild(dummy);
  }

  for (let d=1; d<=lastDay.getDate(); d++){
    const cell = document.createElement("div");
    cell.className = "day";
    cell.textContent = d;
    const cellDate = new Date(y, m, d); cellDate.setHours(0,0,0,0);

    const s = calState.start ? new Date(calState.start) : null;
    const e = calState.end ? new Date(calState.end) : null;
    if (s && sameDay(cellDate, s)) cell.classList.add("sel");
    if (e && sameDay(cellDate, e)) cell.classList.add("sel");
    if (s && e && cellDate > s && cellDate < e) cell.classList.add("range");

    cell.addEventListener("click", ()=>{
      if (!calState.start || (calState.start && calState.end)){
        calState.start = cellDate; calState.end = null;
      } else {
        if (cellDate < calState.start){ calState.end = calState.start; calState.start = cellDate; }
        else { calState.end = cellDate; }
      }
      renderCalendar();
    });

    calGrid.appendChild(cell);
  }
}
function sameDay(a,b){ return a.getFullYear()===b.getFullYear() && a.getMonth()===b.getMonth() && a.getDate()===b.getDate(); }

/* =======================
   FILTRAGEM E M√âTRICAS
   ======================= */
function inRange(iso, range){
  const t = new Date(iso).getTime();
  return t >= range.start.getTime() && t <= range.end.getTime();
}
function filtrar(leads, calls, range, usuario, funil){
  let L = leads.filter(l => inRange(l.created_at, range));
  if (usuario) L = L.filter(l => l.vendedor === usuario);
  if (funil)   L = L.filter(l => l.pipeline === funil);
  let C = calls.filter(c => inRange(c.created_at, range));
  if (usuario) C = C.filter(c => c.created_by === usuario);
  return { leads:L, calls:C };
}
function calcularCards(leads){
  const total = leads.length;
  const won  = leads.filter(l => norm(l.etapa).includes("ganho"));
  const lost = leads.filter(l => norm(l.etapa).includes("perd"));
  const valorWon  = won.reduce((s,l)=>s+l.valor,0);
  const valorLost = lost.reduce((s,l)=>s+l.valor,0);
  const ticket    = won.length ? (valorWon / won.length) : 0;
  const cycles = won.filter(l => l.closed_at).map(l => (new Date(l.closed_at) - new Date(l.created_at)) / (24*3600*1000));
  const ciclo  = cycles.length ? Math.round(cycles.reduce((a,b)=>a+b,0) / cycles.length) : "-";
  return { total, wonQ: won.length, wonV: valorWon, lostQ: lost.length, lostV: valorLost, ticket, ciclo };
}
function renderCards(m){
  document.getElementById("ganhos-qtd").textContent   = m.wonQ;
  document.getElementById("ganhos-valor").textContent = toBRL(m.wonV);
  document.getElementById("perdas-qtd").textContent   = m.lostQ;
  document.getElementById("perdas-valor").textContent = toBRL(m.lostV);
  document.getElementById("card-total").textContent   = m.total;
  document.getElementById("card-ticket").textContent  = toBRL(m.ticket);
  document.getElementById("card-ciclo").textContent   = String(m.ciclo);
}

/* =======================
   CHART UTILS
   ======================= */
let CHARTS = {};
function destroy(id){ if(CHARTS[id]){ CHARTS[id].destroy(); delete CHARTS[id]; } }
const baseOpts = {
  responsive:true, maintainAspectRatio:false, animation:false,
  plugins:{ legend:{display:false} },
  scales:{ x:{ grid:{color:"#222735"}, ticks:{color:"#8993a8"} }, y:{ grid:{color:"#222735"}, ticks:{color:"#8993a8"} } }
};
const valueLabels = {
  id:'valueLabels',
  afterDatasetsDraw(chart){
    const {ctx} = chart;
    chart.data.datasets.forEach((ds, di)=>{
      const meta = chart.getDatasetMeta(di);
      meta.data.forEach((bar, i)=>{
        const v = ds.data[i];
        if (v == null) return;
        const label = (ds.label && ds.label.includes("Valor")) ? toBRL(v*1000) : String(v);
        const {x,y} = bar.tooltipPosition();
        ctx.save(); ctx.font = "600 12px system-ui"; ctx.fillStyle = "#e8eaee";
        const w = (bar.width || (bar.base - bar.x));
        if (w < 40) { ctx.textAlign="left";  ctx.fillText(label, bar.x + 6, y+4); }
        else        { ctx.textAlign="right"; ctx.fillText(label, bar.x + w - 6, y+4); }
        ctx.restore();
      });
    });
  }
};

/* =======================
   PROSPEC√á√ÉO ATIVA (canvas) ‚Äî n√∫meros por cima da barra
   ======================= */
const OUTBOUND_STEPS = [
  "Prospects","Contato estabelecido","Contato decisor","Qualificado",
  "Reuni√£o an√°lise","Proposta apresentada","Ganho"
];
function drawProspeccao(canvas, steps, counts){
  const ctx = canvas.getContext("2d");
  const rowH=42, gap=24, percH=12, top=24, bottom=24;
  const totalH = top + bottom + steps.length*(rowH+gap) + (steps.length-1)*(percH+6);
  const W = canvas.width  = canvas.clientWidth;
  const H = canvas.height = totalH;

  const leftPad = 200;
  const maxW = W - leftPad - 40;
  const minW = Math.max(maxW * 0.45, 180);
  const widths = steps.map((_,i)=> Math.round(maxW - ( (maxW - minW) * (i/(steps.length-1||1)) )));

  const barColor   = getComputedStyle(document.documentElement).getPropertyValue('--bar').trim() || "#cbd5e1";
  const edgeColor  = getComputedStyle(document.documentElement).getPropertyValue('--bar2').trim() || "#94a3b8";
  const textColor  = "#e8eaee";
  const percentBg  = "#1f2430";
  const percentFg  = "#aeb6c5";

  const shadow = () => { ctx.shadowColor="rgba(0,0,0,.35)"; ctx.shadowBlur=18; ctx.shadowOffsetY=12; };
  const clearShadow = () => { ctx.shadowColor="transparent"; ctx.shadowBlur=0; ctx.shadowOffsetY=0; };

  ctx.clearRect(0,0,W,H);
  ctx.font = "14px system-ui, -apple-system, Segoe UI, Roboto";

  let y = top;
  for (let i=0;i<steps.length;i++){
    const label = steps[i];
    const cnt   = counts[i] || 0;
    const bw    = widths[i];
    const x     = leftPad;
    const h     = rowH;

    // label √† esquerda
    ctx.fillStyle = textColor;
    ctx.textAlign = "right";
    ctx.textBaseline = "middle";
    ctx.fillText(label, x - 16, y + h/2);

    // barra chanfrada com sombra
    shadow();
    ctx.fillStyle = barColor;
    const tip = 16;
    ctx.beginPath();
    ctx.moveTo(x, y);
    ctx.lineTo(x + bw - tip, y);
    ctx.lineTo(x + bw, y + h/2);
    ctx.lineTo(x + bw - tip, y + h);
    ctx.lineTo(x, y + h);
    ctx.closePath();
    ctx.fill();
    clearShadow();

    // aresta
    ctx.strokeStyle = edgeColor; ctx.lineWidth=1;
    ctx.beginPath();
    ctx.moveTo(x + bw - tip, y);
    ctx.lineTo(x + bw, y + h/2);
    ctx.lineTo(x + bw - tip, y + h);
    ctx.stroke();

    // n√∫mero por cima (depois da barra)
    ctx.fillStyle = "#0f1115";
    ctx.font = "700 16px system-ui";
    ctx.textAlign = "left";
    ctx.textBaseline = "middle";
    ctx.strokeStyle = "rgba(255,255,255,.35)";
    ctx.lineWidth = 2;
    ctx.strokeText(String(cnt), x + 10, y + h/2);
    ctx.fillText(String(cnt), x + 10, y + h/2);

    // barra percentual
    if (i>0){
      const prev = counts[i-1] || 0;
      const perc = prev ? Math.round((cnt/prev)*100) : 0;
      const py = y + h + 8;
      ctx.fillStyle = percentBg; ctx.fillRect(x, py, maxW, percH);
      const pw = Math.max(Math.round(maxW * (perc/100)), 0);
      ctx.fillStyle = percentFg; ctx.fillRect(x, py, pw, percH);
      ctx.fillStyle = textColor; ctx.font = "600 12px system-ui"; ctx.textAlign="left";
      ctx.fillText(perc + "%", x + pw + 8, py + percH - 2);
      y += percH + 6;
    }

    y += h + gap;
  }
}

/* =======================
   RENDERIZA√á√ïES
   ======================= */
function renderProspeccaoAtiva(leads){
  const outbound = leads.filter(l => {
    const s = norm(l.source);
    return s.includes("google sheet") || s.includes("planilha do google");
  });
  const counts = OUTBOUND_STEPS.map(step => {
    const tag = step.toLowerCase();
    return outbound.filter(l => tagsToArray(l.tags).map(t=>t.toLowerCase()).includes(tag)).length;
  });
  const box = document.getElementById("box-prosp");
  const cvs = document.getElementById("chart-prospeccao");
  drawProspeccao(cvs, OUTBOUND_STEPS, counts);
  box.style.height = cvs.height + "px";
}

function renderCanais(leads){
  const ganhos = leads.filter(l => norm(l.etapa).includes("ganho"));
  const labels = ALL_CHANNELS.length ? ALL_CHANNELS : Array.from(new Set(leads.map(l=>l.canal || "‚Äî")));
  const byCanal = Object.fromEntries(labels.map(k => [k, ganhos.filter(g => (g.canal||"‚Äî")===k)]));
  const qtd = labels.map(k => byCanal[k].length);
  const val = labels.map(k => byCanal[k].reduce((s,l)=>s+l.valor,0));

  destroy("chart-canais");
  CHARTS["chart-canais"] = new Chart(document.getElementById("chart-canais"), {
    type:"bar",
    plugins:[valueLabels],
    data:{ labels,
      datasets:[
        { label:"Qtd ganhos", data:qtd, backgroundColor:"rgba(203,213,225,.95)", borderRadius:8, barPercentage:0.6, categoryPercentage:0.7 },
        { label:"Valor ganho (R$ mil)", data:val.map(v=>v/1000), backgroundColor:"rgba(148,163,184,.95)", borderRadius:8, barPercentage:0.6, categoryPercentage:0.7 }
      ]},
    options:{
      responsive:true, maintainAspectRatio:false, animation:false, indexAxis:"y",
      scales:{ x:{ grid:{display:false}, ticks:{color:"#8993a8"} }, y:{ grid:{display:false}, ticks:{color:"#8993a8"} } },
      plugins:{ legend:{display:true, labels:{color:"#aeb6c5"}} }
    }
  });
}

function renderUsuarios(leads){
  const ganhos = leads.filter(l => norm(l.etapa).includes("ganho"));
  const labels = ALL.users.length ? ALL.users : Array.from(new Set(leads.map(l=>l.vendedor||"‚Äî")));
  const byUser = Object.fromEntries(labels.map(k => [k, ganhos.filter(g => (g.vendedor||"‚Äî")===k)]));
  const qtd = labels.map(k => byUser[k].length);
  const val = labels.map(k => byUser[k].reduce((s,l)=>s+l.valor,0));

  destroy("chart-usuarios");
  CHARTS["chart-usuarios"] = new Chart(document.getElementById("chart-usuarios"), {
    type:"bar",
    plugins:[valueLabels],
    data:{ labels,
      datasets:[
        { label:"Qtd ganhos", data:qtd, backgroundColor:"rgba(203,213,225,.95)", borderRadius:8, barPercentage:0.6, categoryPercentage:0.7 },
        { label:"Valor ganho (R$ mil)", data:val.map(v=>v/1000), backgroundColor:"rgba(148,163,184,.95)", borderRadius:8, barPercentage:0.6, categoryPercentage:0.7 }
      ]},
    options:{
      responsive:true, maintainAspectRatio:false, animation:false, indexAxis:"y",
      scales:{ x:{ grid:{display:false}, ticks:{color:"#8993a8"} }, y:{ grid:{display:false}, ticks:{color:"#8993a8"} } },
      plugins:{ legend:{display:true, labels:{color:"#aeb6c5"}} }
    }
  });
}

function renderChamadasLinha(calls, range){
  // agrega por dia (>=0) e r√≥tulo apenas DIA (1..31)
  const map = new Map();
  for (let d = new Date(range.start); d <= range.end; d = new Date(d.getTime()+86400000)){
    const iso = d.toISOString().slice(0,10);
    map.set(iso, 0);
  }
  calls.forEach(c => {
    const iso = new Date(c.created_at).toISOString().slice(0,10);
    if (map.has(iso)) map.set(iso, Math.max(0, map.get(iso) + 1));
  });
  const labelsISO = Array.from(map.keys()).sort();
  const data = labelsISO.map(k => map.get(k));
  const dayLabels = labelsISO.map(iso => String(Number(iso.slice(8,10))));

  destroy("chart-chamadas");
  CHARTS["chart-chamadas"] = new Chart(document.getElementById("chart-chamadas"), {
    type:"line",
    data:{ labels: dayLabels, datasets:[{ data, borderColor:"rgba(226,232,240,.9)", tension:.35, fill:false, pointRadius:2 }] },
    options:{
      responsive:true, maintainAspectRatio:false, animation:false,
      plugins:{ legend:{display:false} },
      scales:{
        x:{ grid:{color:"#222735"}, ticks:{color:"#8993a8"} },
        y:{ grid:{color:"#222735"}, ticks:{color:"#8993a8"}, beginAtZero:true, suggestedMin:0 }
      }
    }
  });
}

/* =======================
   BOOT + APLICA√á√ÉO
   ======================= */
async function hydrateFilters(){
  // Preenche Usu√°rios e Funis com base nos dados carregados (ALL)
  fUsuario.innerHTML = `<option value="">Todos</option>` +
    ALL.users.map(u => `<option value="${String(u).replace(/"/g,'&quot;')}">${u}</option>`).join("");

  const names = ALL.pipelines;
  fFunil.innerHTML = `<option value="">Todos</option>` +
    names.map(n => `<option value="${String(n).replace(/"/g,'&quot;')}">${n}</option>`).join("");

  fPeriodo.value = "ultima-semana"; // padr√£o
}

function setChannelsFromLeads(){
  ALL_CHANNELS = Array.from(new Set(ALL.leads.map(l => l.canal || "‚Äî")));
}

function setPeriodSummary(choice){
  const range = getRange(choice);
  setPeriodSummaryLabel(choice, range);
}

async function applyAll(){
  const choice = fPeriodo.value || "ultima-semana";
  const range  = getRange(choice);
  const usuario= fUsuario.value || "";
  const funil  = fFunil.value   || "";

  setPeriodSummaryLabel(choice, range);

  const leads = ALL.leads.filter(l => {
    return inRange(l.created_at, range) &&
      (!usuario || l.vendedor === usuario) &&
      (!funil || l.pipeline === funil);
  });
  const calls = ALL.calls.filter(c => {
    return inRange(c.created_at, range) &&
      (!usuario || c.created_by === usuario);
  });

  renderCards(calcularCards(leads));
  renderProspeccaoAtiva(leads);
  renderCanais(leads);
  renderChamadasLinha(calls, range);
  renderUsuarios(leads);
}

async function boot(){
  const force = qs("refresh")==="1"; // ?refresh=1
  let needFetch = shouldFetchNow(force);
  const cache = getCache();

  if (!needFetch && cache && cache.data){
    // usa cache e renderiza imediato
    ALL = cache.data;
  } else {
    // busca do servidor e salva cache com TS
    const data = await fetchAllFromServer();
    ALL = data;
    setCache({ ts: new Date().toISOString(), data });
  }

  setChannelsFromLeads();
  await hydrateFilters();
  setPeriodSummary(fPeriodo.value);
  applyAll();
}

document.addEventListener("DOMContentLoaded", () => {
  // bot√£o para for√ßar atualiza√ß√£o manual
  btnRefresh.addEventListener("click", async ()=>{
    const data = await fetchAllFromServer();
    ALL = data;
    setCache({ ts: new Date().toISOString(), data });
    setChannelsFromLeads();
    await hydrateFilters();
    applyAll();
  });

  [fPeriodo, fUsuario, fFunil].forEach(el => el.addEventListener("change", applyAll));

  boot().catch(e => { alert("Falha ao carregar: "+e.message); console.error(e); });
});
</script>
</body>
</html>
